function findGMMAll(K, times)
    level = 2;
    contract = 2;
    smallMax = 60;
    smallM = ones(level,1);
    smallM(2) = smallMax;
    for i = 3:level
       smallM(i) = floor(smallM(i-1)/contract); 
    end
    f = fopen(['gmm up to ',K,'gaussians.html'],'w');
    for large = 1:level
       for small = large+1:level
           for k = 2:K
               mu = zeros(contract,k); Pi = zeros(contract,k);sigma = zeros(contract,k);
               KL = ones(contract,1);
              for rem = 0:contract-1
                  distr = genDistr(small,large,k,rem,smallM(small),level,contract);
                 for t = 1:times
                     [mm,pp,ss,kk] = findGMM(distr,smallM(small));
                     if (kk < KL(rem+1))
                        mu(rem+1,:) = mm; Pi(rem+1,:) = pp; sigma(rem+1,:) = ss;
                        KL(rem+1) = kk;
                     end
                 end
                 x = [-smallM(small):smallM(small)]';
                 p = genNormrnd(x,mu(rem+1,:),Pi(rem+1,:),sigma(rem+1,:));
                 drawGMM(x,p,distr,small,large,rem,k,KL(rem+1));;
              end
           end
       end
    end
    fclose(f);
end

function [KL, mu, sigma, Pi] = findGMM(small,large,rem,K,smallMax)
    name = getNames();
    dataSetSize = size(name, 1);
    maxDisp = getMaxDisp();
    [maxDisp,IX] = sort(maxDisp);
%     maxDisp
    name = name(IX);
    level = 2;
    contract = 2;
    smallMax = 60;
    smallM = ones(level,1);
    smallM(2) = smallMax;
    for i = 3:level
       smallM(i) = floor(smallM(i-1)/contract); 
    end
    
    KL = zeros(level,level);
    for large = 1:level
        for  small = large+1:level
            f = fopen(['x_',int2str(small-1),int2str(large-1),'.txt'],'w');
            x = [];
            distr = zeros(2*smallM(small)+1,1);
            
            for i = 1:dataSetSize
%                [dd, xx] = getX(['data/Prob_Gen_',name{i},'__'], smallM(small), f, floor(maxDisp(i)/2^(small-1))+1 ,floor(maxDisp(i)/2^(large-1))+1,small,large);
               dd = getX(['data/Prob_Gen_',name{i},'__'], smallM(small), f, floor(maxDisp(i)/2^(small-1))+1 ,floor(maxDisp(i)/2^(large-1))+1,small,large);
%                x = [x;xx]; 
               distr = distr+dd;
            end
            fclose(f);
            gmm = gmdistribution.fit([-smallM(small):smallM(small)]',distr,K);
            mu = gmm.mu
            Pi = gmm.PComponents
            sigma = squeeze(gmm.Sigma)
            
            f = fopen(['distr_',int2str(small-1),int2str(large-1),'.txt'],'w');
            s = sum(distr);
            distr = distr/s;
            printDistr(distr, f);
            fclose(f);
            
            X = [-smallM(small):smallM(small)]';
            p = genNormrnd(X,mu,Pi,sigma,K);
            drawGMM(X,p,distr,small,large);
            KL(small,large) = KLDiv(p,distr)
         end
    end
end
% ---------------------for gen x,distr,normrnd for KL----------------------
% function [distr, x] = getX(dataset,  smallMAX, f, mSmall,mLarge, small, large)
function distr = getX(dataset,  smallMAX, f, mSmall,mLarge, small, large)
    A = read([dataset,'MST_cnt_',int2str(small-1),'_',int2str(large-1),'.txt'], mSmall, mLarge);
     
    distr = zeros(2*smallMAX+1,1); 
    N = sum(sum(A));
    x = zeros(N,1);
    cnt = 0;
    for j = 1:mLarge
        for i=1:mSmall
            d = i-1-floor((j-1)/2);
            index = d+1+smallMAX;
            distr(index) = distr(index)+A(i,j);
%             for n = 1:A(i,j)
%                 cnt = cnt+1;
%                 x(cnt) = d;
%                 fprintf(f,'%d\n',d);
%             end
        end
    end
end
function y = genNormrnd(X,mu, Pi, sigma, K)
    y = zeros(size(X));
    for k = 1:K
        xx = X-mu(k);
        y = y+Pi(k)*exp(-xx.*xx/(2*sigma(k)))/(sqrt(2*pi*sigma(k)));
    end
end
% ------------------------------for file IO--------------------------------
function printDistr(distr, f)
    n = size(distr,1);
    for i = 1:n
       fprintf(f, '%f\n',distr(i)); 
    end
end
function A = read(filename, m, n)
    A = zeros(m, n);
    file = fopen(filename, 'r');
    for i = 1:m
        A(i,:) = fscanf(file, '%d ',[1, n]);
        fscanf(file, '\n');
    end
    fclose(file);
end

% ------------------------------for drawing--------------------------------
function drawGMM(X,p,distr,small,large)
     figure();
     plot(X,distr,'b');hold on;
     plot(X,p,'r');
     title(['gmm ',int2str(small-1),int2str(large-1),' red one is generated']);
end
%-------------------------------data set-----------------------------------
function name = getNames()
    name = {'cones';'teddy';'Baby1';'Cloth1'; 'Cloth2'; 'Rocks2';'Midd1';'Midd2';'Monopoly'};
%     name = {'Aloe'};
%     name = {'Midd1';'Midd2';'Monopoly'};
%     name = {'Baby1';'Cloth1'; 'Cloth2'; 'Rocks2';'Midd1';'Midd2';'Monopoly'};
%     name = {'Plastic'};
%     name = {'cones';'teddy';...
%             'Aloe';'Baby1';'Baby2';'Baby3';'Bowling1';'Bowling2';'Cloth1';...
%             'Cloth2';'Cloth3';'Cloth4';'Flowerpots';'Lampshade1';...
%             'Lampshade2';'Midd1';'Midd2';'Monopoly';'Plastic';'Rocks1';...
%             'Rocks2';'Wood1';'Wood2'};
%     name = {'cones';'teddy';'tsukuba';'venus';...
%             'Aloe';'Baby1';'Baby2';'Baby3';'Bowling1';'Bowling2';'Cloth1';...
%             'Cloth2';'Cloth3';'Cloth4';'Flowerpots';'Lampshade1';...
%             'Lampshade2';'Midd1';'Midd2';'Monopoly';'Plastic';'Rocks1';...
%             'Rocks2';'Wood1';'Wood2'};
end

function disp = getMaxDisp()
    disp = [60,60,100, 96, 86, 91, 65, 71, 79];
%     disp = [90];
%     disp = [65, 71, 79];
%     disp = 93;
%     disp = [100, 96, 86, 91, 65, 71, 79];
%     disp = [60,60,...
%             90,100,100,83,96,80,96,...
%             86,96,86,83,86,...
%             86,65,71,79,93,91,...
%             91,70,84];
%     disp = [60,60,16,20,...
%             90,100,100,83,96,80,96,...
%             86,96,86,83,86,...
%             86,65,71,79,93,91,...
%             91,70,84];
end
